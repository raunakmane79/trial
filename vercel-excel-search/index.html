<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel Search & Download</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display: flex; gap: 12px; align-items: baseline; flex-wrap: wrap; }
    h1 { margin: 0; }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    input, select, button { padding: 8px; font-size: 0.95rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { cursor: pointer; text-align: left; }
    #status { color: #555; }
  </style>
</head>
<body>
  <header>
    <h1>Excel Search & Download</h1>
    <span id="status">Loading…</span>
  </header>

  <div class="controls">
    <label>Sheet:
      <select id="sheetSelect"></select>
    </label>
    <input id="search" type="search" placeholder="Type keyword…" />
    <button id="preview">Preview</button>
    <button id="download">Download Excel</button>
  </div>

  <div id="count"></div>
  <div id="tableWrap"></div>

  <script>
    const sheetSelect = document.getElementById('sheetSelect');
    const statusEl = document.getElementById('status');
    const searchEl = document.getElementById('search');
    const previewBtn = document.getElementById('preview');
    const downloadBtn = document.getElementById('download');
    const tableWrap = document.getElementById('tableWrap');
    const countEl = document.getElementById('count');

    let data = [];
    let sortKey = null;
    let sortAsc = true;

    async function fetchSheets() {
      const res = await fetch('/api/sheets');
      const json = await res.json();
      sheetSelect.innerHTML = json.sheets.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    async function loadSheetPreview() {
      const sheet = sheetSelect.value || '';
      const res = await fetch(`/api/data?sheet=${encodeURIComponent(sheet)}`);
      const json = await res.json();
      if (json.error) throw new Error(json.error);
      data = json.rows;
      statusEl.textContent = `Loaded sheet: ${json.sheet}`;
      countEl.textContent = `${json.count} total rows`;
      renderTable(data);
    }

    function renderTable(src) {
      const q = searchEl.value.trim().toLowerCase();
      const rows = q
        ? src.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(q)))
        : src.slice();

      const headers = rows.length ? Object.keys(rows[0]) : [];
      if (sortKey) {
        rows.sort((a, b) => {
          const av = a[sortKey]; const bv = b[sortKey];
          if (av == null && bv == null) return 0;
          if (av == null) return sortAsc ? -1 : 1;
          if (bv == null) return sortAsc ? 1 : -1;
          if (av < bv) return sortAsc ? -1 : 1;
          if (av > bv) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      const thead = `<thead><tr>${
        headers.map(h => `<th data-key="${h}">${h}${sortKey === h ? (sortAsc ? ' ▲' : ' ▼') : ''}</th>`).join('')
      }</tr></thead>`;

      const tbody = `<tbody>${
        rows.map(r => `<tr>${
          headers.map(h => `<td>${r[h] ?? ''}</td>`).join('')
        }</tr>`).join('')
      }</tbody>`;

      tableWrap.innerHTML = rows.length
        ? `<table>${thead}${tbody}</table>`
        : `<p>No rows match your search.</p>`;

      tableWrap.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
          renderTable(src);
        });
      });
    }

    previewBtn.addEventListener('click', loadSheetPreview);
    searchEl.addEventListener('input', () => renderTable(data));
    downloadBtn.addEventListener('click', () => {
      const q = searchEl.value.trim();
      if (!q) { alert('Enter a search term'); return; }
      const sheet = sheetSelect.value || '';
      const url = `/api/search?q=${encodeURIComponent(q)}&sheet=${encodeURIComponent(sheet)}`;
      window.location = url;
    });

    (async () => {
      try {
        await fetchSheets();
        await loadSheetPreview();
      } catch (e) {
        statusEl.textContent = e.message;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
